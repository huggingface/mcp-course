# Unit 3 解決方法ウォークスルー: MCPでプルリクエストエージェントを構築する

## 概要

このウォークスルーでは、Unit 3のプルリクエストエージェントの完全な解決方法を説明します。これは、コードの変更を分析し、CI/CDパイプラインを監視し、チームコミュニケーションを自動化することで、開発者がより良いプルリクエストを作成できるようにするMCPサーバーです。この解決方法では、MCPの3つのプリミティブ（Tools、Resources、Prompts）が実際のワークフローで連携して動作することを実演します。

## アーキテクチャ概要

PRエージェントは、完全な自動化システムを段階的に構築する相互接続されたモジュールで構成されています：

1. **Build MCP Server** - PRテンプレート提案用のToolsを含む基本サーバー
2. **Smart File Analysis** - プロジェクトコンテキスト用のResourcesを使用した拡張分析
3. **GitHub Actions Integration** - 標準化されたPromptsを使用したCI/CD監視
4. **Hugging Face Hub Integration** - モデルデプロイメントとデータセットPRワークフロー
5. **Slack Notification** - すべてのMCPプリミティブを統合したチームコミュニケーション

## モジュール1: Build MCP Server

### 構築するもの
MCPツールを使用してファイルの変更を分析し、適切なPRテンプレートを提案する最小限のMCPサーバー。

### 主要コンポーネント

#### 1. サーバー初期化 (`server.py`)
```python
# サーバーは3つの重要なツールを登録します：
# - analyze_file_changes: 変更されたファイルに関する構造化データを返す
# - get_pr_templates: メタデータ付きの利用可能なテンプレートをリストする
# - suggest_template: インテリジェントなテンプレート推奨を提供する
```

サーバーはMCP SDKを使用してこれらのツールをClaude Codeに公開し、情報を収集して使用するPRテンプレートについて賢明な決定を下すことができます。

#### 2. ファイル分析ツール
`analyze_file_changes`ツールはgit diffを検査して以下を特定します：
- ファイルタイプと拡張子
- 変更されたファイル数
- 追加/削除された行数
- 一般的なパターン（テスト、設定、ドキュメント）

この構造化データにより、Claudeは決定ロジックをハードコーディングすることなく変更の性質を理解できます。

#### 3. テンプレート管理
テンプレートは`templates/`ディレクトリにmarkdownファイルとして保存されます：
- `bug.md` - バグ修正用
- `feature.md` - 新機能用
- `docs.md` - ドキュメント更新用
- `refactor.md` - コードリファクタリング用

各テンプレートには、Claudeが分析に基づいて入力できるプレースホルダーが含まれています。

### Claudeがこれらのツールを使用する方法

1. Claudeは`analyze_file_changes`を呼び出して何が変更されたかを理解します
2. `get_pr_templates`を使用して利用可能なオプションを確認します
3. 分析データを使用して`suggest_template`を呼び出します
4. 理由付きの推奨を受け取ります
5. 特定の変更に基づいてテンプレートをカスタマイズできます

### 学習成果
- ツール登録とスキーマの理解
- 構造化データを使用してClaudeに決定を委ねる
- データ収集と決定ロジックの分離

## モジュール2: Smart File Analysis

### 構築するもの
MCPリソースを使用してプロジェクトコンテキストとチームガイドラインを提供する拡張ファイル分析。

### 主要コンポーネント

#### 1. リソース登録
サーバーは4つのタイプのリソースを公開します：
```python
# リソースは以下への読み取り専用アクセスを提供します：
# - file://templates/ - PRテンプレートファイル
# - file://project-context/ - コーディング標準、規約
# - git://recent-changes/ - コミット履歴とパターン
# - team://guidelines/ - レビュープロセスと標準
```

#### 2. プロジェクトコンテキストリソース
`project-context/`ディレクトリには以下が含まれます：
- `coding-standards.md` - 言語固有の規約
- `review-guidelines.md` - レビュアーが確認する項目
- `architecture.md` - システム設計パターン
- `dependencies.md` - サードパーティライブラリポリシー

Claudeはこれらを読み取ってプロジェクト固有の要件を理解できます。

#### 3. Git履歴分析
`git://recent-changes/`リソースは以下を提供します：
- 最近のコミットメッセージとパターン
- 一般的なPRタイトルと説明
- チームメンバーの貢献パターン
- 履歴的なテンプレート使用状況

これにより、Claudeはチームの慣行と一致するテンプレートを提案できます。

### Claudeがリソースを使用する方法

1. `team://guidelines/review-process.md`を読み取ってPR要件を理解します
2. `file://project-context/coding-standards.md`にアクセスしてスタイルガイドを取得します
3. `git://recent-changes/`を分析してチームパターンと一致させます
4. このコンテキストをファイル分析と組み合わせて、より良い提案を行います

### 拡張された意思決定
リソースにより、Claudeは以下のことができるようになります：
- チーム規約と一致するテンプレートを提案する
- PRにプロジェクト固有の要件を含める
- 説明でコーディング標準を参照する
- 履歴的なチーム慣行と整合させる

### 学習成果
- リソースURIの設計とスキーマ
- プロジェクト知識をAIにアクセス可能にする
- コンテキストを意識した意思決定
- 自動化とチーム標準のバランス

## モジュール3: GitHub Actions Integration

### 構築するもの
webhookと一貫したチームコミュニケーションのための標準化されたプロンプトを使用したリアルタイムCI/CD監視。

### 主要コンポーネント

#### 1. Webhookサーバー
Cloudflare TunnelでGitHub Actionsイベントを受信します：
```python
# Webhookエンドポイントは以下を処理します：
# - workflow_runイベント
# - check_runイベント  
# - pull_requestステータス更新
# - デプロイメント通知
```

#### 2. プロンプトテンプレート
4つの標準化されたプロンプトが一貫性を保証します：
- **"Analyze CI Results"** - テスト失敗とビルドエラーを処理
- **"Generate Status Summary"** - 人間が読みやすいステータス更新を作成
- **"Create Follow-up Tasks"** - 結果に基づいて次のステップを提案
- **"Draft Team Notification"** - 異なる対象者向けの更新をフォーマット

#### 3. イベント処理パイプライン
1. GitHubからwebhookを受信
2. イベントデータを解析し、関連情報を抽出
3. イベントタイプに基づいて適切なプロンプトを使用
4. 標準化されたレスポンスを生成
5. チーム通知のために保存

### Claudeがプロンプトを使用する方法

プロンプト使用例：
```python
# テストが失敗した場合、Claudeは"Analyze CI Results"プロンプトを使用します：
prompt_data = {
    "event_type": "workflow_run",
    "status": "failure",
    "failed_jobs": ["unit-tests", "lint"],
    "error_logs": "...",
    "pr_context": {...}
}

# Claudeが生成するもの：
# - 根本原因分析
# - 提案修正
# - 影響評価
# - 次のステップ
```

### 標準化されたワークフロー
プロンプトは、誰が作業していても以下を保証します：
- CI失敗が一貫して分析される
- ステータス更新がチーム形式に従う
- フォローアップアクションがプロセスと整合する
- 通知が必要な情報を含む

### 学習成果
- Webhook統合パターン
- 一貫性のためのプロンプトエンジニアリング
- イベント駆動アーキテクチャ
- チームワークフローの標準化

## モジュール4: Hugging Face Hub Integration

### 構築するもの
LLMとデータセットPR用のHugging Face Hub統合、言語モデルを扱うチーム向けの専用ワークフローを追加。

### 主要コンポーネント

#### 1. Hub固有のツール
```python
# Hugging Faceワークフロー用のツール：
# - analyze_model_changes: LLMファイル変更を検出
# - validate_dataset_format: 訓練データコンプライアンスをチェック
# - generate_model_card: モデルドキュメンテーションを作成/更新
# - suggest_hub_template: LLM/データセット用PRテンプレート
```

#### 2. Hubリソース
```python
# Hubコンテキスト用のリソース：
# - hub://model-cards/ - LLMカードテンプレートと例
# - hub://dataset-formats/ - 訓練データ仕様
# - hub://community-standards/ - Hubコミュニティガイドライン
# - hub://license-info/ - ライセンス互換性チェック
```

#### 3. LLM固有のプロンプト
```python
# LLMワークフロー用のプロンプト：
# - "Analyze Model Changes" - LLM更新を理解
# - "Generate Benchmark Summary" - 評価メトリクスを作成
# - "Check Dataset Quality" - 訓練データを検証
# - "Draft Model Card Update" - ドキュメンテーションを更新
```

### Hub固有のワークフロー

PRがLLMファイルを変更する場合：
1. **ツール**: `analyze_model_changes`がモデルアーキテクチャの変更を検出
2. **リソース**: `hub://model-cards/llm-template.md`を読み取り
3. **プロンプト**: "Generate Benchmark Summary"が評価セクションを作成
4. **ツール**: `generate_model_card`がドキュメンテーションを更新
5. **リソース**: `hub://license-info/`で互換性をチェック

### データセットPR処理
訓練データ更新の場合：
- 形式の一貫性を検証
- データ品質メトリクスをチェック
- データセットカードを更新
- 適切なレビュアーを提案

### 学習成果
- Hugging Face Hub API統合
- LLM固有のPRワークフロー
- モデルとデータセットドキュメンテーション
- コミュニティ標準準拠

## モジュール5: Slack Notification

### 構築するもの
完全なワークフロー自動化のためにTools、Resources、Promptsを組み合わせた自動チーム通知。

### 主要コンポーネント

#### 1. コミュニケーションツール
```python
# チーム更新用の3つのツール：
# - send_slack_message: チームチャンネルに投稿
# - get_team_members: 通知対象者を特定
# - track_notification_status: 配信を監視
```

#### 2. チームリソース
```python
# チームデータ用のリソース：
# - team://members/ - 開発者プロフィールと設定
# - slack://channels/ - チャンネル設定
# - notification://templates/ - メッセージ形式
```

#### 3. 通知プロンプト
```python
# コミュニケーション用のプロンプト：
# - "Format Team Update" - メッセージを適切にスタイル
# - "Choose Communication Channel" - 適切な対象者を選択
# - "Escalate if Critical" - 緊急問題を処理
```

### 統合例

重要なPRでCIが失敗した場合：
1. **ツール**: `get_team_members`がPR作成者とレビュアーを特定
2. **リソース**: `team://members/{user}/preferences`が通知設定をチェック
3. **プロンプト**: "Format Team Update"が適切なメッセージを作成
4. **ツール**: `send_slack_message`が適切なチャンネルに配信
5. **リソース**: `notification://templates/ci-failure`が一貫した形式を保証
6. **プロンプト**: "Escalate if Critical"が追加アラートが必要かを判断

### インテリジェントルーティング
システムは以下を考慮します：
- チームメンバーの空き状況（カレンダーリソースから）
- 通知設定（メール vs Slack）
- メッセージの緊急度（PRラベルに基づく）
- タイムゾーンと勤務時間

### 学習成果
- プリミティブ統合パターン
- 複雑なワークフローオーケストレーション
- 自動化と人間のニーズのバランス
- 本番環境対応のエラー処理

## 完全なワークフロー例

典型的なPRでのすべてのコンポーネントの連携方法：

1. **開発者がPRを作成**
   - GitHub webhookがサーバーをトリガー
   - ツール: `analyze_file_changes`がdiffを調査
   - リソース: チームガイドラインとプロジェクトコンテキストを読み取り
   - プロンプト: 最適なPRテンプレートを提案

2. **CI/CDパイプライン実行**
   - Webhookがワークフローイベントを受信
   - プロンプト: "Analyze CI Results"が結果を処理
   - リソース: チームエスカレーションポリシーをチェック
   - ツール: GitHubでPRステータスを更新

3. **Hugging Face Hub統合**
   - ツール: LLM/データセット変更を検出
   - リソース: Hubガイドラインを読み取り
   - プロンプト: モデルカード更新を生成
   - ツール: Hub標準に対して検証

4. **チーム通知**
   - ツール: 関連チームメンバーを特定
   - リソース: 通知設定を読み取り
   - プロンプト: 適切なメッセージをフォーマット
   - ツール: Slackチャンネル経由で送信

5. **フォローアップアクション**
   - プロンプト: "Create Follow-up Tasks"が次のステップを生成
   - ツール: 必要に応じてGitHub issueを作成
   - リソース: ドキュメンテーションにリンク
   - すべてのプリミティブがシームレスに連携

## テスト戦略

### 単体テスト
各モジュールには包括的な単体テストが含まれます：
- ツールスキーマ検証
- リソースURI解析
- プロンプトテンプレートレンダリング
- 統合シナリオ

### 統合テスト
エンドツーエンドテストのカバー範囲：
- 完全なPRワークフロー
- エラー回復シナリオ
- 負荷下でのパフォーマンス
- セキュリティ検証

### テスト構造
```
tests/
├── unit/
│   ├── test_tools.py
│   ├── test_resources.py
│   ├── test_prompts.py
│   └── test_integration.py
├── integration/
│   ├── test_workflow.py
│   ├── test_webhooks.py
│   └── test_notifications.py
└── fixtures/
    ├── sample_events.json
    └── mock_responses.json
```

## 解決方法の実行

### ローカル開発環境設定
1. **MCPサーバーを開始**: `python server.py`
2. **Claude Codeを設定**: サーバーをMCP設定に追加
3. **Cloudflare Tunnelを設定**: `cloudflared tunnel --url http://localhost:3000`
4. **Webhookを設定**: GitHubリポジトリにトンネルURLを追加
5. **ワークフローをテスト**: PRを作成して自動化を確認

### 設定
簡単なセットアップのためのファイルベース設定：
- `.env`ファイルのGitHubトークン
- 設定のSlack webhook
- `templates/`のテンプレートカスタマイゼーション
- すべての設定を1箇所に

## 一般的なパターンとベストプラクティス

### ツール設計
- ツールを集中的で単一目的に保つ
- AI解釈のための構造化データを返す
- 包括的なエラーメッセージを含める
- ツールスキーマにバージョンを付ける

### リソース整理
- 明確なURI階層を使用
- リソース発見を実装
- 頻繁にアクセスされるリソースをキャッシュ
- すべてのリソースをバージョン管理

### プロンプトエンジニアリング
- プロンプトを具体的だが柔軟にする
- コンテキストと例を含める
- 様々な入力でテスト
- プロンプトライブラリを維持

### 統合パターン
- 疎結合のためのイベントを使用
- サーキットブレーカーを実装
- バックオフ付きリトライを追加
- すべての外部呼び出しを監視

## トラブルシューティングガイド

### 一般的な問題

1. **Webhookがイベントを受信しない**
   - Cloudflare Tunnelが実行中かチェック
   - GitHub webhook設定を確認
   - シークレットが一致することを確認

2. **ツールがClaudeに表示されない**
   - ツールスキーマを検証
   - サーバー登録をチェック
   - MCP接続を確認

3. **リソースにアクセスできない**
   - ファイル権限を確認
   - URI形式をチェック
   - リソース登録を確認

4. **プロンプトが一貫しない結果を生成**
   - プロンプトテンプレートを確認
   - 提供されたコンテキストをチェック
   - 入力形式を検証

## 次のステップと拡張

### 潜在的な拡張
1. より多くのコード分析ツールを追加（複雑さ、セキュリティ）
2. より多くのコミュニケーションプラットフォームと統合
3. カスタムワークフロー定義を追加
4. PR自動マージ機能を実装

### 学習パス
- **次**: Unit 4 - このサーバーをリモートデプロイ
- **上級**: カスタムMCPプロトコル拡張
- **エキスパート**: マルチサーバーオーケストレーション

## 結論

このPRエージェントは、MCPの3つのプリミティブが連携して動作する力を実演しています。ツールは機能を提供し、リソースはコンテキストを提供し、プロンプトは一貫性を保証します。組み合わせることで、チーム標準を維持しながら開発者の生産性を向上させるインテリジェントな自動化システムを作成します。

モジュラーアーキテクチャにより、各コンポーネントを独立して理解、テスト、拡張できる一方で、統合は本番環境のMCPサーバーで使用する実際のパターンを示しています。