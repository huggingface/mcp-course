# Tiny æ™ºèƒ½ä½“ï¼š50 è¡Œä»£ç å®ç°çš„ MCP é©±åŠ¨æ™ºèƒ½ä½“

ç°åœ¨æˆ‘ä»¬å·²ç»ç”¨ Gradio æ„å»ºäº† MCP æœåŠ¡å™¨ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ·±å…¥æ¢ç´¢ MCP å®¢æˆ·ç«¯ã€‚æœ¬èŠ‚åŸºäºå®éªŒæ€§é¡¹ç›® [Tiny Agents](https://huggingface.co/blog/tiny-agents)ï¼Œè¯¥é¡¹ç›®å±•ç¤ºäº†å¦‚ä½•æç®€åœ°éƒ¨ç½²å¯è¿æ¥æœåŠ¡ï¼ˆå¦‚æˆ‘ä»¬çš„ Gradio æƒ…æ„Ÿåˆ†ææœåŠ¡å™¨ï¼‰çš„ MCP å®¢æˆ·ç«¯ã€‚

åœ¨è¿™ä¸ªç®€çŸ­ç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬å°†æŒ‡å¯¼æ‚¨å®ç°ä¸€ä¸ª TypeScript (JS) MCP å®¢æˆ·ç«¯ï¼Œè¯¥å®¢æˆ·ç«¯å¯ä¸ä»»ä½• MCP æœåŠ¡å™¨é€šä¿¡ï¼ˆåŒ…æ‹¬æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚æ„å»ºçš„åŸºäº Gradio çš„æƒ…æ„Ÿåˆ†ææœåŠ¡å™¨ï¼‰ã€‚æ‚¨å°†çœ‹åˆ° MCP å¦‚ä½•æ ‡å‡†åŒ–æ™ºèƒ½ä½“ä¸å·¥å…·çš„äº¤äº’æ–¹å¼ï¼Œä»è€Œæ˜¾è‘—ç®€åŒ– Agentic AI çš„å¼€å‘ã€‚

![meme](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/tiny-agents/thumbnail.jpg)
<figcaption>å›¾ç‰‡è‡´è°¢ https://x.com/adamdotdev</figcaption>

æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•å°†æ‚¨çš„å¾®å‹æ™ºèƒ½ä½“è¿æ¥åˆ°åŸºäº Gradio çš„ MCP æœåŠ¡å™¨ï¼Œä½¿å…¶èƒ½å¤ŸåŒæ—¶ä½¿ç”¨æ‚¨è‡ªå®šä¹‰çš„æƒ…æ„Ÿåˆ†æå·¥å…·å’Œå…¶ä»–é¢„æ„å»ºå·¥å…·ã€‚

## å¦‚ä½•è¿è¡Œå®Œæ•´æ¼”ç¤º

å¦‚æœæ‚¨å·²å®‰è£… NodeJSï¼ˆåŒ…å« `pnpm` æˆ– `npm`ï¼‰ï¼Œåªéœ€åœ¨ç»ˆç«¯è¿è¡Œï¼š

```bash
npx @huggingface/mcp-client
```

æˆ–è€…ä½¿ç”¨ `pnpm`ï¼š

```bash
pnpx @huggingface/mcp-client
```

è¯¥å‘½ä»¤ä¼šå°†åŒ…å®‰è£…åˆ°ä¸´æ—¶ç›®å½•å¹¶æ‰§è¡Œå…¶å‘½ä»¤ã€‚

æ‚¨å°†çœ‹åˆ°æ‚¨çš„ç®€æ˜“æ™ºèƒ½ä½“è¿æ¥åˆ°å¤šä¸ªæœ¬åœ°è¿è¡Œçš„ MCP æœåŠ¡å™¨ï¼ŒåŠ è½½å®ƒä»¬çš„å·¥å…·ï¼ˆç±»ä¼¼äºåŠ è½½ Gradio æƒ…æ„Ÿåˆ†æå·¥å…·çš„æ–¹å¼ï¼‰ï¼Œç„¶åè¿›å…¥å¯¹è¯æç¤ºæ¨¡å¼ã€‚

<video controls autoplay loop>
  <source src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/tiny-agents/use-filesystem.mp4" type="video/mp4">
</video>

é»˜è®¤æƒ…å†µä¸‹ï¼Œç¤ºä¾‹æ™ºèƒ½ä½“ä¼šè¿æ¥ä»¥ä¸‹ä¸¤ä¸ª MCP æœåŠ¡å™¨ï¼š
- æ ‡å‡†[æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨](https://github.com/modelcontextprotocol/servers/tree/main/src/filesystem)ï¼Œå¯è®¿é—®æ‚¨çš„æ¡Œé¢
- [Playwright MCP](https://github.com/microsoft/playwright-mcp) æœåŠ¡å™¨ï¼Œæä¾›æ²™ç›’åŒ– Chromium æµè§ˆå™¨æ”¯æŒ

æ‚¨å¯ä»¥è½»æ¾å°† Gradio æƒ…æ„Ÿåˆ†ææœåŠ¡å™¨æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼ˆæœ¬èŠ‚åç»­å°†æ¼”ç¤ºï¼‰ã€‚

> [!NOTE]
> æ³¨æ„ï¼šå½“å‰æ‰€æœ‰å¾®å‹æ™ºèƒ½ä½“ä¸­çš„ MCP æœåŠ¡å™¨å®é™…ä¸Šéƒ½æ˜¯æœ¬åœ°è¿›ç¨‹ï¼ˆè¿œç¨‹æœåŠ¡å™¨æ”¯æŒå³å°†æ¨å‡ºï¼‰ï¼Œè¿™ä¸åŒ…æ‹¬è¿è¡Œåœ¨ localhost:7860 çš„ Gradio æœåŠ¡å™¨ã€‚

ç¬¬ä¸€ä¸ªè§†é¢‘çš„è¾“å…¥ç¤ºä¾‹ï¼š
> å†™ä¸€é¦–å…³äº Hugging Face ç¤¾åŒºçš„ä¿³å¥ï¼Œå¹¶ä¿å­˜åˆ°æ¡Œé¢åä¸º "hf.txt" çš„æ–‡ä»¶

ç°åœ¨å°è¯•æ¶‰åŠç½‘é¡µæµè§ˆçš„æç¤ºï¼š
> åœ¨ Brave Search ä¸Šæœç´¢ HF æ¨ç†æœåŠ¡æä¾›å•†å¹¶æ‰“å¼€å‰ 3 ä¸ªç»“æœ

<video controls autoplay loop>
  <source src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/tiny-agents/brave-search.mp4" type="video/mp4">
</video>

å½“è¿æ¥ Gradio æƒ…æ„Ÿåˆ†æå·¥å…·åï¼Œå¯ä»¥ç±»ä¼¼åœ°è¯¢é—®ï¼š
> åˆ†æè¿™æ¡è¯„è®ºçš„æƒ…æ„Ÿï¼š"æˆ‘å®Œå…¨çˆ±ä¸Šäº†è¿™ä¸ªäº§å“ï¼Œå®ƒè¶…å‡ºäº†æˆ‘æ‰€æœ‰çš„é¢„æœŸï¼"

### é»˜è®¤æ¨¡å‹ä¸æä¾›å•†

ç¤ºä¾‹æ™ºèƒ½ä½“é»˜è®¤ä½¿ç”¨ä»¥ä¸‹æ¨¡å‹/æä¾›å•†ç»„åˆï¼š
- ["Qwen/Qwen2.5-72B-Instruct"](https://huggingface.co/Qwen/Qwen2.5-72B-Instruct)
- è¿è¡Œäº [Nebius](https://huggingface.co/docs/inference-providers/providers/nebius) å¹³å°

è¿™äº›é…ç½®å‡å¯é€šè¿‡ç¯å¢ƒå˜é‡ä¿®æ”¹ï¼ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºå¦‚ä½•æ·»åŠ  Gradio MCP æœåŠ¡å™¨ï¼š

```ts
const agent = new Agent({
	provider: process.env.PROVIDER ?? "nebius",
	model: process.env.MODEL_ID ?? "Qwen/Qwen2.5-72B-Instruct",
	apiKey: process.env.HF_TOKEN,
	servers: [
		// Default servers
		{
			command: "npx",
			args: ["@modelcontextprotocol/servers", "filesystem"]
		},
		{
			command: "npx",
			args: ["playwright-mcp"]
		},
		// Our Gradio sentiment analysis server
		{
			command: "npx",
			args: [
				"mcp-remote",
				"http://localhost:7860/gradio_api/mcp/sse"
			]
		}
	],
});
```

<Tip>

æˆ‘ä»¬é€šè¿‡ [`mcp-remote`](https://www.npmjs.com/package/mcp-remote) åŒ…è¿æ¥åˆ°åŸºäº Gradio çš„ MCP æœåŠ¡å™¨ã€‚

</Tip>


## å®ç°è¿™ä¸€ç›®æ ‡çš„åŸºç¡€ï¼šLLM åŸç”Ÿæ”¯æŒå·¥å…·è°ƒç”¨ã€‚

ä¹‹æ‰€ä»¥èƒ½å¤Ÿå°† Gradio MCP æœåŠ¡å™¨è¿æ¥åˆ°æˆ‘ä»¬çš„ Tiny Agentï¼Œæ˜¯å› ä¸ºæœ€è¿‘çš„ LLMï¼ˆåŒ…æ‹¬å°é—­å¼å’Œå¼€æ”¾å¼ï¼‰éƒ½ç»è¿‡äº†å‡½æ•°è°ƒç”¨ï¼ˆä¹Ÿå°±æ˜¯å·¥å…·ä½¿ç”¨ï¼‰çš„è®­ç»ƒã€‚åŒæ ·çš„åŠŸèƒ½ä¹Ÿæ”¯æŒæˆ‘ä»¬ä¸ä½¿ç”¨ Gradio æ„å»ºçš„æƒ…ç»ªåˆ†æå·¥å…·çš„é›†æˆã€‚

å·¥å…·ç”±å…¶åç§°ã€æè¿°ä»¥åŠå…¶å‚æ•°çš„ JSONSchema è¡¨ç¤ºå½¢å¼å®šä¹‰â€”â€”è¿™ä¸æˆ‘ä»¬åœ¨ Gradio æœåŠ¡å™¨ä¸­å®šä¹‰æƒ…ç»ªåˆ†æå‡½æ•°çš„æ–¹å¼å®Œå…¨ç›¸åŒã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

```ts
const weatherTool = {
	type: "function",
	function: {
		name: "get_weather",
		description: "Get current temperature for a given location.",
		parameters: {
			type: "object",
			properties: {
				location: {
					type: "string",
					description: "City and country e.g. BogotÃ¡, Colombia",
				},
			},
		},
	},
};
```

æˆ‘ä»¬çš„ Gradio æƒ…æ„Ÿåˆ†æå·¥å…·ç»“æ„ç±»ä¼¼ï¼Œä½†è¾“å…¥å‚æ•°ä½¿ç”¨ `text` æ›¿ä»£ `location`ã€‚

è¿™é‡Œå¼•ç”¨çš„æƒå¨æ–‡æ¡£æ˜¯ [OpenAI çš„å‡½æ•°è°ƒç”¨æ–‡æ¡£](https://platform.openai.com/docs/guides/function-calling?api-mode=chat)ã€‚ï¼ˆæ˜¯çš„... OpenAI å‡ ä¹ä¸ºæ•´ä¸ªç¤¾åŒºå®šä¹‰äº† LLM çš„æ ‡å‡† ğŸ˜…ï¼‰

æ¨ç†å¼•æ“å…è®¸æ‚¨åœ¨è°ƒç”¨ LLM æ—¶ä¼ é€’å·¥å…·åˆ—è¡¨ï¼ŒLLM å¯ä»¥è‡ªç”±é€‰æ‹©è°ƒç”¨é›¶ä¸ªã€ä¸€ä¸ªæˆ–å¤šä¸ªå·¥å…·ã€‚
ä½œä¸ºå¼€å‘è€…ï¼Œæ‚¨éœ€è¦æ‰§è¡Œè¿™äº›å·¥å…·å¹¶å°†ç»“æœåé¦ˆç»™ LLM ä»¥ç»§ç»­ç”Ÿæˆã€‚

> æ³¨æ„ï¼šåœ¨åç«¯ï¼ˆæ¨ç†å¼•æ“å±‚é¢ï¼‰ï¼Œå·¥å…·ä¼šä»¥ç‰¹æ®Šæ ¼å¼çš„ [chat_template](file://e:\githubProjects\transformers\src\transformers\models\llava_onevision\convert_llava_onevision_weights_to_hf.py#L58-L58) ä¼ é€’ç»™æ¨¡å‹ï¼ˆå¦‚åŒå…¶ä»–æ¶ˆæ¯ï¼‰ï¼Œç„¶åä»å“åº”ä¸­è§£æå‡ºæ¥ï¼ˆä½¿ç”¨æ¨¡å‹ç‰¹å®šçš„ç‰¹æ®Šæ ‡è®°ï¼‰ä»¥æš´éœ²ä¸ºå·¥å…·è°ƒç”¨ã€‚

## åœ¨ InferenceClient ä¸Šå®ç° MCP å®¢æˆ·ç«¯

ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£ç°ä»£ LLM ä¸­å·¥å…·çš„å®šä¹‰ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬å®ç°çœŸæ­£çš„ MCP å®¢æˆ·ç«¯ï¼Œç”¨äºä¸ Gradio æœåŠ¡å™¨å’Œå…¶ä»– MCP æœåŠ¡å™¨é€šä¿¡ã€‚

[å®˜æ–¹æ–‡æ¡£](https://modelcontextprotocol.io/quickstart/client) ç¼–å†™å¾—ç›¸å½“å®Œå–„ã€‚æ‚¨åªéœ€å°† Anthropic å®¢æˆ·ç«¯ SDK çš„å¼•ç”¨æ›¿æ¢ä¸ºå…¶ä»– OpenAI å…¼å®¹çš„ SDK å³å¯ï¼ˆè¿™é‡Œè¿˜æä¾›äº†å¯è¾“å…¥ LLM çš„ [llms.txt](https://modelcontextprotocol.io/llms-full.txt) æ¥è¾…åŠ©ç¼–ç ï¼‰ã€‚

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ HF çš„ `InferenceClient` ä½œä¸ºæ¨ç†å®¢æˆ·ç«¯ã€‚

> [!TIP]
> å®Œæ•´çš„ `McpClient.ts` ä»£ç æ–‡ä»¶å¯åœ¨[æ­¤å¤„](https://github.com/huggingface/huggingface.js/blob/main/packages/mcp-client/src/McpClient.ts)æŸ¥é˜… ğŸ¤“

æˆ‘ä»¬çš„ `McpClient` ç±»åŒ…å«ï¼š
- æ¨ç†å®¢æˆ·ç«¯ï¼ˆæ”¯æŒä»»æ„æ¨ç†æä¾›å•†ï¼Œ`huggingface/inference` åŒæ—¶æ”¯æŒè¿œç¨‹å’Œæœ¬åœ°ç«¯ç‚¹ï¼‰
- ä¸€ç»„ MCP å®¢æˆ·ç«¯ä¼šè¯ï¼ˆæ¯ä¸ªè¿æ¥çš„ MCP æœåŠ¡å™¨å¯¹åº”ä¸€ä¸ªä¼šè¯ï¼Œæ”¯æŒè¿æ¥å¤šä¸ªæœåŠ¡å™¨åŒ…æ‹¬ Gradio æœåŠ¡å™¨ï¼‰
- å¯ç”¨å·¥å…·åˆ—è¡¨ï¼ˆä»è¿æ¥çš„æœåŠ¡å™¨è·å–å¹¶ç¨ä½œæ ¼å¼åŒ–ï¼‰

```ts
export class McpClient {
	protected client: InferenceClient;
	protected provider: string;
	protected model: string;
	private clients: Map<ToolName, Client> = new Map();
	public readonly availableTools: ChatCompletionInputTool[] = [];

	constructor({ provider, model, apiKey }: { provider: InferenceProvider; model: string; apiKey: string }) {
		this.client = new InferenceClient(apiKey);
		this.provider = provider;
		this.model = model;
	}
	
	// [...]
}
```

ä¸ºäº†è¿æ¥åˆ° MCP æœåŠ¡å™¨ï¼ˆä¾‹å¦‚æˆ‘ä»¬çš„ Gradio æƒ…ç»ªåˆ†ææœåŠ¡å™¨ï¼‰ï¼Œå®˜æ–¹çš„ `@modelcontextprotocol/sdk/client` TypeScript SDK æä¾›äº†ä¸€ä¸ªå¸¦æœ‰ `listTools()` æ–¹æ³•çš„ `Client` ç±»ï¼š

```ts
async addMcpServer(server: StdioServerParameters): Promise<void> {
	const transport = new StdioClientTransport({
		...server,
		env: { ...server.env, PATH: process.env.PATH ?? "" },
	});
	const mcp = new Client({ name: "@huggingface/mcp-client", version: packageVersion });
	await mcp.connect(transport);

	const toolsResult = await mcp.listTools();
	debug(
		"Connected to server with tools:",
		toolsResult.tools.map(({ name }) => name)
	);

	for (const tool of toolsResult.tools) {
		this.clients.set(tool.name, mcp);
	}

	this.availableTools.push(
		...toolsResult.tools.map((tool) => {
			return {
				type: "function",
				function: {
					name: tool.name,
					description: tool.description,
					parameters: tool.inputSchema,
				},
			} satisfies ChatCompletionInputTool;
		})
	);
}
```

`StdioServerParameters` æ˜¯ MCP SDK ä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå¯è®©æ‚¨è½»æ¾åˆ›å»ºæœ¬åœ°è¿›ç¨‹ï¼šå¦‚å‰æ‰€è¿°ï¼Œç›®å‰æ‰€æœ‰ MCP æœåŠ¡å™¨å®é™…ä¸Šéƒ½æ˜¯æœ¬åœ°è¿›ç¨‹ï¼ŒåŒ…æ‹¬æˆ‘ä»¬çš„ Gradio æœåŠ¡å™¨ï¼ˆå°½ç®¡æˆ‘ä»¬é€šè¿‡ HTTP è®¿é—®å®ƒï¼‰ã€‚

å¯¹äºæˆ‘ä»¬è¿æ¥çš„æ¯ä¸ª MCP æœåŠ¡å™¨ï¼ˆåŒ…æ‹¬æˆ‘ä»¬çš„ Gradio æƒ…ç»ªåˆ†ææœåŠ¡å™¨ï¼‰ï¼Œæˆ‘ä»¬éƒ½ä¼šç¨å¾®é‡æ–°æ ¼å¼åŒ–å…¶å·¥å…·åˆ—è¡¨ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° `this.availableTools` ä¸­ã€‚

### å¦‚ä½•ä½¿ç”¨å·¥å…·

ä½¿ç”¨æˆ‘ä»¬çš„æƒ…ç»ªåˆ†æå·¥å…·ï¼ˆæˆ–ä»»ä½•å…¶ä»– MCP å·¥å…·ï¼‰éå¸¸ç®€å•ã€‚æ‚¨åªéœ€å°† `this.availableTools` ä¼ é€’ç»™æ‚¨çš„ LLM èŠå¤©å®Œæˆå‡½æ•°ï¼Œä»¥åŠæ‚¨å¸¸ç”¨çš„æ¶ˆæ¯æ•°ç»„å³å¯ï¼š

```ts
const stream = this.client.chatCompletionStream({
	provider: this.provider,
	model: this.model,
	messages,
	tools: this.availableTools,
	tool_choice: "auto",
});
```

`tool_choice: "auto"` æ˜¯æ‚¨ä¼ é€’ç»™ LLM çš„å‚æ•°ï¼Œç”¨äºç”Ÿæˆé›¶ä¸ªã€ä¸€ä¸ªæˆ–å¤šä¸ªå·¥å…·è°ƒç”¨ã€‚

åœ¨è§£ææˆ–æµå¼ä¼ è¾“è¾“å‡ºæ—¶ï¼ŒLLM ä¼šç”Ÿæˆä¸€äº›å·¥å…·è°ƒç”¨ï¼ˆä¾‹å¦‚å‡½æ•°åç§°å’Œä¸€äº› JSON ç¼–ç çš„å‚æ•°ï¼‰ï¼Œæ‚¨ï¼ˆä½œä¸ºå¼€å‘è€…ï¼‰éœ€è¦è®¡ç®—è¿™äº›è°ƒç”¨ã€‚MCP å®¢æˆ·ç«¯ SDK å†æ¬¡ç®€åŒ–äº†è®¡ç®—è¿‡ç¨‹ï¼›å®ƒæœ‰ä¸€ä¸ª `client.callTool()` æ–¹æ³•ï¼š

```ts
const toolName = toolCall.function.name;
const toolArgs = JSON.parse(toolCall.function.arguments);

const toolMessage: ChatCompletionInputMessageTool = {
	role: "tool",
	tool_call_id: toolCall.id,
	content: "",
	name: toolName,
};

/// Get the appropriate session for this tool
const client = this.clients.get(toolName);
if (client) {
	const result = await client.callTool({ name: toolName, arguments: toolArgs });
	toolMessage.content = result.content[0].text;
} else {
	toolMessage.content = `Error: No session found for tool: ${toolName}`;
}
```

å¦‚æœ LLM é€‰æ‹©ä½¿ç”¨æˆ‘ä»¬çš„æƒ…æ„Ÿåˆ†æå·¥å…·ï¼Œè¿™æ®µä»£ç ä¼šè‡ªåŠ¨å°†è°ƒç”¨è·¯ç”±åˆ° Gradio æœåŠ¡å™¨ï¼Œæ‰§è¡Œåˆ†æå¹¶å°†ç»“æœè¿”å›ç»™ LLMã€‚

æœ€åæ‚¨éœ€è¦å°†å·¥å…·æ¶ˆæ¯ç»“æœæ·»åŠ åˆ° `messages` æ•°ç»„å¹¶ä¼ å› LLMã€‚

## 50 è¡Œä»£ç å®ç°çš„æ™ºèƒ½ä½“ ğŸ¤¯

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†èƒ½è¿æ¥ä»»æ„ MCP æœåŠ¡å™¨ï¼ˆåŒ…æ‹¬ Gradio æƒ…æ„Ÿåˆ†ææœåŠ¡å™¨ï¼‰è·å–å·¥å…·åˆ—è¡¨ï¼Œå¹¶èƒ½å°†å·¥å…·æ³¨å…¥ LLM æ¨ç†æµç¨‹çš„ MCP å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆ... ç©¶ç«Ÿä»€ä¹ˆæ˜¯æ™ºèƒ½ä½“ï¼Ÿ

> å½“æ‚¨æ‹¥æœ‰å¸¦å·¥å…·é›†çš„æ¨ç†å®¢æˆ·ç«¯åï¼Œæ™ºèƒ½ä½“æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ª while å¾ªç¯ã€‚

æ›´å…·ä½“åœ°è¯´ï¼Œæ™ºèƒ½ä½“ç”±ä»¥ä¸‹è¦ç´ æ„æˆï¼š
- ç³»ç»Ÿæç¤º
- LLM æ¨ç†å®¢æˆ·ç«¯
- è¿æ¥å¤šä¸ª MCP æœåŠ¡å™¨ï¼ˆåŒ…æ‹¬ Gradio æœåŠ¡å™¨ï¼‰å·¥å…·çš„ MCP å®¢æˆ·ç«¯
- åŸºç¡€æ§åˆ¶æµï¼ˆè§ä¸‹æ–¹ while å¾ªç¯ï¼‰

> [!TIP]
> å®Œæ•´ `Agent.ts` ä»£ç æ–‡ä»¶å¯[åœ¨æ­¤å¤„](https://github.com/huggingface/huggingface.js/blob/main/packages/mcp-client/src/Agent.ts)æŸ¥çœ‹ã€‚

æˆ‘ä»¬çš„æ™ºèƒ½ä½“ç±»ç›´æ¥ç»§æ‰¿è‡ª McpClientï¼š

```ts
export class Agent extends McpClient {
	private readonly servers: StdioServerParameters[];
	protected messages: ChatCompletionInputMessage[];

	constructor({
		provider,
		model,
		apiKey,
		servers,
		prompt,
	}: {
		provider: InferenceProvider;
		model: string;
		apiKey: string;
		servers: StdioServerParameters[];
		prompt?: string;
	}) {
		super({ provider, model, apiKey });
		this.servers = servers;
		this.messages = [
			{
				role: "system",
				content: prompt ?? DEFAULT_SYSTEM_PROMPT,
			},
		];
	}
}
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å— [GPT-4.1 æç¤ºæŒ‡å—](https://cookbook.openai.com/examples/gpt4-1_prompting_guide) å¯å‘çš„æç®€ç³»ç»Ÿæç¤ºã€‚

å°½ç®¡è¿™æ¥è‡ª OpenAI ğŸ˜ˆï¼Œä½†ä»¥ä¸‹å£°æ˜è¶Šæ¥è¶Šé€‚ç”¨äºé—­æºå’Œå¼€æºæ¨¡å‹ï¼š
> æˆ‘ä»¬å»ºè®®å¼€å‘è€…ä»…é€šè¿‡ tools å­—æ®µä¼ é€’å·¥å…·ï¼Œè€Œéåƒè¿‡å»æŸäº›åšæ³•é‚£æ ·æ‰‹åŠ¨åœ¨æç¤ºä¸­æ³¨å…¥å·¥å…·æè¿°å¹¶ç¼–å†™ç‹¬ç«‹çš„å·¥å…·è°ƒç”¨è§£æå™¨ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬æ— éœ€åœ¨ç³»ç»Ÿæç¤ºä¸­ç²¾å¿ƒç¼–æ’å·¥å…·ä½¿ç”¨ç¤ºä¾‹ã€‚`tools: this.availableTools` å‚æ•°å·²è¶³å¤Ÿï¼ŒLLM å°†è‡ªåŠ¨æŒæ¡æ–‡ä»¶ç³»ç»Ÿå·¥å…·å’Œ Gradio æƒ…æ„Ÿåˆ†æå·¥å…·çš„ä½¿ç”¨æ–¹æ³•ã€‚

åŠ è½½æ™ºèƒ½ä½“å·¥å…·çš„æ“ä½œæœ¬è´¨ä¸Šå°±æ˜¯è¿æ¥æ‰€éœ€çš„ MCP æœåŠ¡å™¨ï¼ˆå€ŸåŠ© JS çš„å¹¶è¡Œç‰¹æ€§å¯è½»æ¾å®ç°ï¼‰ï¼š

```ts
async loadTools(): Promise<void> {
	await Promise.all(this.servers.map((s) => this.addMcpServer(s)));
}
```

æˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªé¢å¤–çš„å·¥å…·ï¼ˆMCP ä¹‹å¤–ï¼‰ï¼Œå¯ä¾› LLM ç”¨äºæˆ‘ä»¬çš„æ™ºèƒ½ä½“çš„æ§åˆ¶æµï¼š

```ts
const taskCompletionTool: ChatCompletionInputTool = {
	type: "function",
	function: {
		name: "task_complete",
		description: "Call this tool when the task given by the user is complete",
		parameters: {
			type: "object",
			properties: {},
		},
	},
};
const askQuestionTool: ChatCompletionInputTool = {
	type: "function",
	function: {
		name: "ask_question",
		description: "Ask a question to the user to get more info required to solve or clarify their problem.",
		parameters: {
			type: "object",
			properties: {},
		},
	},
};
const exitLoopTools = [taskCompletionTool, askQuestionTool];
```

å½“è°ƒç”¨ä»»ä½•è¿™äº›å·¥å…·æ—¶ï¼Œæ™ºèƒ½ä½“éƒ½ä¼šä¸­æ–­å¾ªç¯ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤è¿˜ç»™ç”¨æˆ·ï¼Œä»¥ä¾¿ç”¨æˆ·è¾“å…¥æ–°çš„è¾“å…¥ã€‚

### å®Œæ•´çš„ while å¾ªç¯

çœ‹çœ‹æˆ‘ä»¬å®Œæ•´çš„ while å¾ªç¯ã€‚ğŸ‰

æ™ºèƒ½ä½“ä¸» while å¾ªç¯çš„è¦ç‚¹æ˜¯ï¼Œæˆ‘ä»¬ç®€å•åœ°è¿­ä»£ LLMï¼Œäº¤æ›¿è°ƒç”¨å·¥å…·å¹¶å‘å…¶æä¾›å·¥å…·ç»“æœï¼Œ**ç›´åˆ° LLM å¼€å§‹è¿ç»­å“åº”ä¸¤æ¡éå·¥å…·æ¶ˆæ¯**ã€‚

è¿™æ˜¯å®Œæ•´çš„ while å¾ªç¯ï¼š

```ts
let numOfTurns = 0;
let nextTurnShouldCallTools = true;
while (true) {
	try {
		yield* this.processSingleTurnWithTools(this.messages, {
			exitLoopTools,
			exitIfFirstChunkNoTool: numOfTurns > 0 && nextTurnShouldCallTools,
			abortSignal: opts.abortSignal,
		});
	} catch (err) {
		if (err instanceof Error && err.message === "AbortError") {
			return;
		}
		throw err;
	}
	numOfTurns++;
	const currentLast = this.messages.at(-1)!;
	if (
		currentLast.role === "tool" &&
		currentLast.name &&
		exitLoopTools.map((t) => t.function.name).includes(currentLast.name)
	) {
		return;
	}
	if (currentLast.role !== "tool" && numOfTurns > MAX_NUM_TURNS) {
		return;
	}
	if (currentLast.role !== "tool" && nextTurnShouldCallTools) {
		return;
	}
	if (currentLast.role === "tool") {
		nextTurnShouldCallTools = false;
	} else {
		nextTurnShouldCallTools = true;
	}
}
```

## å°† Tiny Agent ä¸ Gradio MCP æœåŠ¡å™¨è¿æ¥

ç°åœ¨æˆ‘ä»¬äº†è§£äº† Tiny Agent å’Œ Gradio MCP æœåŠ¡å™¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼MCP çš„ä¼˜ç‚¹åœ¨äºå®ƒä¸ºæ™ºèƒ½ä½“æä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹å¼ï¼Œä½¿å…¶èƒ½å¤Ÿä¸ä»»ä½•å…¼å®¹ MCP çš„æœåŠ¡å™¨ï¼ˆåŒ…æ‹¬æˆ‘ä»¬åŸºäº Gradio çš„æƒ…ç»ªåˆ†ææœåŠ¡å™¨ï¼‰è¿›è¡Œäº¤äº’ã€‚

### å°† Gradio æœåŠ¡å™¨ä¸ Tiny Agent é…åˆä½¿ç”¨

è¦å°† Tiny Agent è¿æ¥åˆ°æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„ Gradio æƒ…ç»ªåˆ†ææœåŠ¡å™¨ï¼Œæˆ‘ä»¬åªéœ€å°†å…¶æ·»åŠ åˆ°æœåŠ¡å™¨åˆ—è¡¨ä¸­å³å¯ã€‚ä»¥ä¸‹æ˜¯ä¿®æ”¹æ™ºèƒ½ä½“é…ç½®çš„æ–¹æ³•ï¼š

```ts
const agent = new Agent({
    provider: process.env.PROVIDER ?? "nebius",
    model: process.env.MODEL_ID ?? "Qwen/Qwen2.5-72B-Instruct",
    apiKey: process.env.HF_TOKEN,
    servers: [
        // ... existing servers ...
        {
            command: "npx",
            args: [
                "mcp-remote",
                "http://localhost:7860/gradio_api/mcp/sse"  // Your Gradio MCP server
            ]
        }
    ],
});
```

ç°åœ¨æˆ‘ä»¬çš„æ™ºèƒ½ä½“å¯ä»¥åŒæ—¶ä½¿ç”¨æƒ…æ„Ÿåˆ†æå·¥å…·å’Œå…¶ä»–å·¥å…·ï¼ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ï¼š
1. ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨ä»æ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬
2. ä½¿ç”¨æˆ‘ä»¬çš„ Gradio æœåŠ¡å™¨åˆ†æå…¶æƒ…æ„Ÿ
3. å°†ç»“æœå†™å›åˆ°æ–°æ–‡ä»¶ä¸­

### ç¤ºä¾‹äº¤äº’

ä»¥ä¸‹æ˜¯ä¸æˆ‘ä»¬çš„æ™ºèƒ½ä½“è¿›è¡Œå¯¹è¯çš„ç¤ºä¾‹ï¼š

```
ç”¨æˆ·ï¼šè¯»å–æˆ‘æ¡Œé¢ä¸Šçš„ "feedback.txt" æ–‡ä»¶å¹¶åˆ†æå…¶æƒ…æ„Ÿ

æ™ºèƒ½ä½“ï¼šæˆ‘å°†å¸®åŠ©æ‚¨åˆ†æåé¦ˆæ–‡ä»¶çš„æƒ…æ„Ÿã€‚ä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤ï¼š

é¦–å…ˆï¼Œæˆ‘ä¼šä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·è¯»å–æ–‡ä»¶
ç„¶åï¼Œä½¿ç”¨æƒ…æ„Ÿåˆ†æå·¥å…·åˆ†æå…¶æƒ…æ„Ÿ
æœ€åï¼Œå°†ç»“æœå†™å…¥æ–°æ–‡ä»¶
[æ™ºèƒ½ä½“ç»§ç»­ä½¿ç”¨å·¥å…·å¹¶æä¾›åˆ†æç»“æœ]
```

### éƒ¨ç½²æ³¨æ„äº‹é¡¹

å½“å°† Gradio MCP æœåŠ¡å™¨éƒ¨ç½²åˆ° Hugging Face Spaces æ—¶ï¼Œæ‚¨éœ€è¦æ›´æ–°æ™ºèƒ½ä½“é…ç½®ä¸­çš„æœåŠ¡å™¨ URL ä»¥æŒ‡å‘å·²éƒ¨ç½²çš„ç©ºé—´ï¼š

```ts
{
    command: "npx",
    args: [
        "mcp-remote",
        "https://YOUR_USERNAME-mcp-sentiment.hf.space/gradio_api/mcp/sse"
    ]
}
```

è¿™ä½¿å¾—æ‚¨çš„æ™ºèƒ½ä½“å¯ä»¥ä»ä»»ä½•åœ°æ–¹ä½¿ç”¨æƒ…ç»ªåˆ†æå·¥å…·ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨æœ¬åœ°ï¼



